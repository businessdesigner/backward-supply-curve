<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<script src="http://d3js.org/d3.v3.min.js"></script>
  	<script src="./src/regression.js"></script>
	<script src="helperFunctions.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore.js" type="text/javascript"></script>
	<!-- Styling -->
	<link href="style.css" rel="stylesheet" type="text/css">
	<link href="https://fonts.googleapis.com/css?family=Amatic+SC:700|Raleway:300,400" rel="stylesheet">

	<!-- <link rel="stylesheet" href="bootstrap-select.min.css">
	<script src=”src/bootstrap.min.js”></script> -->
<!--     <script src="src/jquery-3.1.1.min.js"></script>
    	<link rel=”stylesheet” href=”bootstrap.min.css”>
	<script src="src/bootstrap-select.js"></script> -->

<!-- Radio button styling -->

<!-- 	<link href="skins/square/green.css" rel="stylesheet">
	<script src="src/icheck.js"></script>

	<script>
	$(document).ready(function(){
	  $('input').iCheck({
	    // checkboxClass: 'icheckbox_square-green',
	    radioClass: 'iradio_square-green',
	    // increaseArea: '20%' // optional
	  });
	});
	</script> -->

</head>
<body>
<div class="container">
<h1>Reflection on Thy Own Life</h1>
<h2>How Americans Live Their Lives and the Effects of Wage Rate</h2>
<blockquote>We are all mortals, and each is for himself. - Molière</blockquote>
<p style="width:75%; display:inline-block">When we are swamped up in our daily turmoils with the ups and downs, the fun and boredom, the happy and sad, have you ever wondered if you are doing okay compared with others? Did you put your time and efforts in the right place?
<br>
Using the dataset from <a href="http://www.icpsr.umich.edu/icpsrweb/NADAC/studies/36268" target="_blank">American Time Use Survey</a>, we present to you a discovery journey on how your American counterparts utilize their time. Through your own self-reflection, you could learn about how to make proper adjustments and then lead a fulfilling life.</p>
<img src="figure.png" style="width:10%; display:inline-block; margin-left: 3em">

<div id="part1" class="part">
	<h2>How Americans Spend Their Time</h2>
	<p>On the left-hand side, we recreated the labor supply curve in economics. The x-axis represents "Weekly working hours" and the y-axis represents "hourly wage". Every data point is one person's response, and the trend line is the supply curve. Right-hand side is a pie chart visualizing how Americans spend their time on five main categories of activities.</p>
    <div id="part1-left">
    </div>
    <div id="part1-right">
    </div>
</div>

<h2>Filter and See How Trend Lines Change</h2>
<p>Every criteria could be a determining factor for how the data disbributes. Explore and see.</p>
<div id="part2" class="part" style="height:80vh">
        <form style="line-height: 2">
            <input class="part2_radio" type="radio" name="radio-group" value="Gender" checked>Gender
                        <!-- <label for="Gender">Gender</label><br> -->
            <input class="part2_radio" type="radio" name="radio-group" value="age_group">Age
                        <!-- <label for="Age">Age</label><br> -->
            <input class="part2_radio" type="radio" name="radio-group" value="education_category">Education
                        <!-- <label for="Education">Education</label><br> -->
            <input class="part2_radio" type="radio" name="radio-group" value="metropolitan_category">Urban/Rural Residents
                        <!-- <label for="metropolitan">Urban/Rural Residents</label><br> -->
            <input class="part2_radio" type="radio" name="radio-group" value="partner_category">Living with Partner(s)
                        <!-- <label for="partner">Living with Partner(s)</label><br> -->

            <input class="part2_radio" type="radio" name="radio-group" value="year">Year
                        <!-- <label for="year">Year</label> -->
        </form>
    <div id="part2-left">
<!--         <form style="line-height: 2">
            <input class="part2_radio" type="radio" name="radio-group" value="Gender" checked>Gender<br>
						<!-- <label for="Gender">Gender</label><br> -->
<!--             <input class="part2_radio" type="radio" name="radio-group" value="age_group">Age<br>
						<!-- <label for="Age">Age</label><br> -->
<!--             <input class="part2_radio" type="radio" name="radio-group" value="education_category">Education<br> -->
						<!-- <label for="Education">Education</label><br> -->
            <!-- <input class="part2_radio" type="radio" name="radio-group" value="metropolitan_category">Urban/Rural Residents<br> -->
						<!-- <label for="metropolitan">Urban/Rural Residents</label><br> -->
           <!--  <input class="part2_radio" type="radio" name="radio-group" value="partner_category">Living with Partner(s)<br> -->
						<!-- <label for="partner">Living with Partner(s)</label><br> -->

<!--             <input class="part2_radio" type="radio" name="radio-group" value="year">Year<br> -->
						<!-- <label for="year">Year</label> -->
<!--         </form> -->
    </div>
    <div id="part2-right">
    </div>
</div>

<div id="part3" class="part">
	<h2>What about Me?</h2>
	<p>Fill in your condition and spot your position compared with others similar to you.</p>
    <div class="filterpanel">
        <div style="display:inline-table">
            <p>Gender</p>
            <select id="part3_select_gender">
              <option value="0">All</option>
              <option value="Female">Female</option>
              <option value="Male">Male</option>
            </select>
        </div>

        <div style="display:inline-table; margin-left: 10px">
            <p>Age</p>
            <select id="part3_select_age">
              <option value="0">All</option>
              <option value="under 20">under 20</option>
              <option value="20-29">20-29</option>
              <option value="30-39">30-39</option>
              <option value="40-49">40-49</option>
              <option value="50-59">50-59</option>
              <option value="over 60">over 60</option>
            </select>
        </div>

        <div style="display:inline-table; margin-left: 10px">
            <p>Education</p>
            <select id="part3_select_education">
              <option value="0">All</option>
              <option value="Primary School">Primary School</option>
              <option value="High School">High School</option>
              <option value="GED">GED</option>
              <option value="College">College</option>
              <option value="Master">Master</option>
              <option value="PhD">PhD</option>
            </select>
        </div>

        <div style="display:inline-table; margin-left: 10px">
            <p>Weekly working hours</p>
            <input type="text" name="work_hr" size="30" placeholder="Type in your weekly work hours" id="part3_input_work">
        </div>

        <div style="display:inline-table; margin-left: 10px">
            <p>Hourly wage</p>
        <input type="text" name="hr_wage" placeholder="Type in your hourly wage" id="part3_input_wage" size="25">
        </div>
        <div style="display:inline-table; margin-left: 10px; padding-top: 40px">
            <br><br>
						<button id="part3_update">Update</button>
        </div>
    </div>
    <div id="part3-left">

    </div>
	<div id="part3-right">

    </div>
</div>

</div>
</body>
<script>
var f = "./data/data_full-time_category.csv"
var degree = 3; // degree of regression

d3.csv(f, function(data) {
    plotPart1(data);
    plotPart2(data);
    plotPart3(data);
});

var line_data_f = "./data/line_data_2.json"
d3.json(line_data_f, function(data) {
	newPlotPart2(data);
});

// d3.select(window).on('resize.updatesvg', updateWindow);
// function updateWindow(){
//     width = d3.select("#part2-right").node().getBoundingClientRect().width
//     height = d3.select("#part2-right").node().getBoundingClientRect().height
//     svg = d3.select("#part2-right").selectAll("svg")
//     .attr("width", width).attr("height", height);
//
//     width = d3.select("#part1-left").node().getBoundingClientRect().width
//     height = d3.select("#part2-right").node().getBoundingClientRect().height
//     svg = d3.select("#part1-left").selectAll("svg")
//     .attr("width", width).attr("height", height);
// }

function plotPart3(data){

    // Set the dimensions of the canvas / graph
    var div_node = d3.select("#part3-left").node()
    var margin = {top: 100, right: 100, bottom: 100, left: 100},
    width = div_node.getBoundingClientRect().width
    height = div_node.getBoundingClientRect().height;

    // Adds the svg canvas
    var svg = d3.select("#part3-left")
        .append("svg")
        .attr("width", width)
        .attr("height", height);

    d3.select("#part3_update").on("click",function(){

        //Check integer of work_hr and wage
        var gender= d3.select("#part3_select_gender").node().value;
        var age= d3.select("#part3_select_age").node().value;
        var education=d3.select("#part3_select_education").node().value;
        var work_hr=d3.select("#part3_input_work").node().value;
        var wage=d3.select("#part3_input_wage").node().value;

        var filtered_data=data.filter(checkDemographic);

        function checkDemographic(d){
            return (d.Gender==gender || gender=="0") &&
            (d.age_group==age || age=="0") &&
            (d.education_category==education || education=="0");
        }

        var data_work_wage = filtered_data.map(function(d) { return [ +d["work_per_week"], +d["wage"] ]; });

        svg.selectAll("*").remove();
		var user_data = undefined;
		if (work_hr !== undefined && wage !== undefined && work_hr !== "" && wage !== "") user_data = [work_hr, wage];
        plotFilteredData(svg, margin, data_work_wage, user_data);

    });

    var data_work_wage = data.map(function(d) { return [ +d["work_per_week"], +d["wage"] ]; });
    plotFilteredData(svg, margin, data_work_wage, undefined);
}

// data should in [[x1, y1], [x2, y2], ...]
function plotFilteredData(svg, margin, data, user_data) {
    var line_data = getRegressionDataForY(data);
    if (user_data !== undefined) { data.push(user_data); }

    var chart = svg.append("g")
            .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")");

    var width = svg.node().getBoundingClientRect().width - margin.left - margin.right;
    var height = svg.node().getBoundingClientRect().height - margin.top - margin.bottom;

    // Set the ranges
    var x = d3.scale.linear().range([0, width]);
    var y = d3.scale.linear().range([height, 0]);

    // Define the axes
    var xAxis = d3.svg.axis().scale(x)
        .orient("bottom").ticks(5);

    var yAxis = d3.svg.axis().scale(y)
        .orient("left").ticks(5);

    // Define the line
    var valueline = d3.svg.line()
        .x(function(d) { return x(d[0]); })
        .y(function(d) { return y(d[1]); })
        .interpolate("basis");

    // Scale the range of the data
    x.domain([0, d3.max(data, function(d) { return d[0]; })]);
    y.domain([0, d3.max(data, function(d) { return d[1]; })]);

    // Add the scatterplot
    chart.selectAll("dot")
        .data(data)
      .enter().append("circle")
        .attr("r", 3.5)
        .attr("cx", function(d) { return x(d[0]); })
        .attr("cy", function(d) { return y(d[1]); });

    // Add the valueline path.
    // chart.append("path")
    //     .attr("class", "line")
    //     .attr("stroke", "steelblue")
    //     .attr("stroke-width", "2")
    //     .attr("fill", "none")
    //     .attr("d", valueline(line_data));

    if(user_data !== undefined) {
        // Add the user data.
        chart.append("circle")
            .attr("r", 6)
            .attr("fill", "red")
            .attr("cx", x(user_data[0]))
            .attr("cy", y(user_data[1]));

    }

    // Add the X Axis
    chart.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + height + ")")
        .call(xAxis);

	chart.append("text")
		.attr("text-anchor", "middle")
		.attr("transform", "translate("+ (-margin.left/2) +","+ height/2+")rotate(-90)")
		.text("Hourly wage rate (USD)")

    // Add the Y Axis
    chart.append("g")
        .attr("class", "y axis")
        .call(yAxis);

	chart.append("text")
		.attr("text-anchor", "middle")
		.attr("transform", "translate("+ (width/2) +","+ (height+(margin.bottom/2))+ ")")
		.text("Weekly working hours (hr)")
}

function newPlotPart2(data) {
	var div_node = d3.select("#part2-left").node()
    var margin = {top: 100, right: 100, bottom: 100, left: 100},
    width = div_node.getBoundingClientRect().width,
    height = div_node.getBoundingClientRect().height;
    var svg = d3.select("#part2-left")
        .append("svg")
        .attr("width", width)
        .attr("height", height);
	svg.selectAll("*").remove();
	d3.selectAll('.part2_radio').on("change",function(){
        var selectedRadio=d3.select('input[name="radio-group"]:checked').node().value;
		var selectedData = data[selectedRadio];
		var data_array = [];
		var maxX = 0, maxY = 0, labels=[];
		for (key in selectedData) {
			data_array.push(selectedData[key]);
			labels.push(key);
			var curMaxX = d3.max(selectedData[key], function(d) { return d[0]; });
			var curMaxY = d3.max(selectedData[key], function(d) { return d[1]; });
			if (maxX < curMaxX) maxX = curMaxX;
			if (maxY < curMaxY) maxY = curMaxY;
		}
        // var return_data = filterDataByKey(data, selectedRadio);
        // var data_array = return_data[0];
        // var labels = return_data[1];
        // var maxX = return_data[2];
        // var maxY = return_data[3];
        svg.selectAll("*").remove();
		// console.log(data_array);
        plotMultipleData(svg, margin, data_array, maxX, maxY);
    })
}

function plotPart2(data) {
    var div_node = d3.select("#part2-right").node()
    var margin = {top: 100, right: 100, bottom: 100, left: 100},
    width = div_node.getBoundingClientRect().width,
    height = div_node.getBoundingClientRect().height;
    var svg = d3.select("#part2-left")
        .append("svg")
        .attr("width", width)
        .attr("height", height);

		// console.log(d3.selectAll('.iradio_square-green').selectAll(this.childNodes));
		console.log(d3.selectAll('.part2_radio'));
		console.log(d3.select('input[name="radio-group"]:checked'));
		console.log(d3.select('input[name="radio-group"]:checked').node());
		console.log(d3.select('input[name="radio-group"]:checked').node().value);

    // d3.selectAll('.part2_radio').on("change",function(){
    //     var selectedRadio=d3.select('input[name="radio-group"]:checked').node().value;
	//
    //     var return_data = filterDataByKey(data, selectedRadio);
    //     var data_array = return_data[0];
    //     var labels = return_data[1];
    //     var maxX = return_data[2];
    //     var maxY = return_data[3];
    //     svg.selectAll("*").remove();
    //     plotMultipleData(svg, margin, data_array, maxX, maxY);
    // })
    var return_data = filterDataByKey(data, d3.select('input[name="radio-group"]:checked').node().value);
    var data_array = return_data[0];
    var labels = return_data[1];
    var maxX = return_data[2];
    var maxY = return_data[3];
    plotMultipleData(svg, margin, data_array, maxX, maxY);
}

function plotMultipleData(svg, margin, data_array, maxX, maxY) {
    var chart = svg.append("g")
            .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")");

    var width = svg.node().getBoundingClientRect().width - margin.left - margin.right;
    var height = svg.node().getBoundingClientRect().height - margin.top - margin.bottom;

    // Set the ranges
    var x = d3.scale.linear().range([0, width]);
    var y = d3.scale.linear().range([height, 0]);

    // Define the axes
    var xAxis = d3.svg.axis().scale(x)
        .orient("bottom").ticks(5);

    var yAxis = d3.svg.axis().scale(y)
        .orient("left").ticks(5);

    // Define the line
    var valueline = d3.svg.line()
        .x(function(d) { return x(d[0]); })
        .y(function(d) { return y(d[1]); })
        .interpolate("basis");

    // Scale the range of the data
    x.domain([0, maxX]);
    y.domain([0, maxY]);

    // var color_code = ["LightPink", "LightBlue", "LightGreen", "LightGoldenRodYellow", "LightSalmon"];
    // var line_color_code = ["red", "blue", "green", "yellow", "orange"];
    var colorScale = d3.scale.category10();

    for (var i in data_array) {
        var line_data = data_array[i];
        chart.append("path")
            .attr("class", "line")
            .attr("stroke", colorScale(i))
            .attr("stroke-width", "2")
            .attr("fill", "none")
            .attr("d", valueline(line_data));
    }

    // Add the X Axis
    chart.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + height + ")")
        .call(xAxis);

	chart.append("text")
		.attr("text-anchor", "middle")
		.attr("transform", "translate("+ (-margin.left/2) +","+ height/2+")rotate(-90)")
		.text("Hourly wage rate (USD)")

    // Add the Y Axis
    chart.append("g")
        .attr("class", "y axis")
        .call(yAxis);

	chart.append("text")
		.attr("text-anchor", "middle")
		.attr("transform", "translate("+ (width/2) +","+ (height+(margin.bottom/2))+ ")")
		.text("Weekly working hours (hr)")
}

function plotPart1(data) {

    // Set the dimensions of the canvas / graph
    var div_node = d3.select("#part1-left").node()
    var margin = {top: 100, right: 100, bottom: 100, left: 100},
    width = div_node.getBoundingClientRect().width
    height = div_node.getBoundingClientRect().height;

    // Adds the svg canvas
    var svg = d3.select("#part1-left")
        .append("svg")
        .attr("width", width)
        .attr("height", height);

    plotDataAndSupplyCurve(svg, margin, data);

    var pieSvg = d3.select("#part1-right")
        .append("svg")
        .attr("width", width)
        .attr("height", height);

    drawPie(pieSvg, margin, data);
}

// data should in [[x1, y1], [x2, y2], ...]
function plotDataAndSupplyCurve(svg, margin, data) {
	var data_subsample = _.sample(data, 1500);
	var data_work_wage = data_subsample.map(function(d) { return [ +d["work_per_week"], +d["wage"] ]; });

	var line_data = getRegressionDataForY(data_work_wage);
    var chart = svg.append("g")
            .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")");

    var width = svg.node().getBoundingClientRect().width - margin.left - margin.right;
    var height = svg.node().getBoundingClientRect().height - margin.top - margin.bottom;

    // Set the ranges
    var x = d3.scale.linear().range([0, width]);
    var y = d3.scale.linear().range([height, 0]);

    // Define the axes
    var xAxis = d3.svg.axis().scale(x)
        .orient("bottom").ticks(5);

    var yAxis = d3.svg.axis().scale(y)
        .orient("left").ticks(5);

    // Define the line
    var valueline = d3.svg.line()
        .x(function(d) { return x(d[0]); })
        .y(function(d) { return y(d[1]); })
        .interpolate("basis");

	var brush = d3.svg.brush()
		.x(x)
		.y(y)
		.on("brushstart", brushstart)
		.on("brush", brushmove)
		.on("brushend", brushend);

    // Scale the range of the data
    x.domain([0, d3.max(data_work_wage, function(d) { return d[0]; })]);
    y.domain([0, d3.max(data_work_wage, function(d) { return d[1]; })]);

    // Add the scatterplot
    chart.selectAll("dot")
        .data(data_work_wage)
      .enter().append("circle")
        .attr("r", 3.5)
        .attr("cx", function(d) { return x(d[0]); })
        .attr("cy", function(d) { return y(d[1]); });

	chart.data(data_work_wage).call(brush);

    // Add the valueline path.
    chart.append("path")
        .attr("class", "line")
        .attr("stroke", "steelblue")
        .attr("stroke-width", "2")
        .attr("fill", "none")
        .attr("d", valueline(line_data));

    // Add the X Axis
    chart.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + height + ")")
        .call(xAxis);

	chart.append("text")
		.attr("text-anchor", "middle")
		.attr("transform", "translate("+ (-margin.left/2) +","+ height/2+")rotate(-90)")
		.text("Hourly wage rate (USD)")

    // Add the Y Axis
    chart.append("g")
        .attr("class", "y axis")
        .call(yAxis);

	chart.append("text")
		.attr("text-anchor", "middle")
		.attr("transform", "translate("+ (width/2) +","+ (height+(margin.bottom/2))+ ")")
		.text("Weekly working hours (hr)")

	var brushCell;
	function brushstart(p) {
		if (brushCell !== this) {
			d3.select(brushCell).call(brush.clear());
			brushCell = this;
		}
	}

	// Highlight the selected circles.
	function brushmove(p) {
		var e = brush.extent(); //this is the brush object that was initialized above as 'brush'
		// data_work_wage = data.map(function(d) { return [ +d["work_per_week"], +d["wage"] ]; });

		chart.selectAll("circle").classed("hidden", function(d) {
			return e[0][0] > d[0] || d[0] > e[1][0]
				|| e[0][1] > d[1] || d[1] > e[1][1];
		});

		selectedData = [];
		chart.selectAll("circle")
			.each(function(d,i) {
				if(!d3.select(this).classed("hidden")) {
					selectedData.push(data_subsample[i]);
				}
			});

		var div_node = d3.select("#part1-left").node()
		var margin = {top: 100, right: 100, bottom: 100, left: 100},
		width = div_node.getBoundingClientRect().width
		height = div_node.getBoundingClientRect().height;
		var pieSvg = d3.select("#part1-right").select("svg");
		pieSvg.selectAll("*").remove();
        if(selectedData.length!==0){
            drawPie(pieSvg, margin, selectedData);
        }

	}

	// If the brush is empty, select all circles.
	function brushend() {
		selectedData = [];
	 	if (brush.empty()) chart.selectAll(".hidden").classed("hidden", false);
	}
}

function drawPie(svg, margin, data) {
    dataset = getPieChartData(data);
    // dataset = [data_dict.travel, data_dict.sleep, data_dict.work, data_dict.household, data_dict.leisure, data_dict.others];

    var chart = svg.append("g")
            .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")");
    chart.append("g")
    	.attr("class", "slices");
    chart.append("g")
    	.attr("class", "labelName");
    chart.append("g")
    	.attr("class", "labelValue");
    chart.append("g")
    	.attr("class", "lines");
    var width = svg.node().getBoundingClientRect().width - margin.left - margin.right;
    var height = svg.node().getBoundingClientRect().height - margin.top - margin.bottom;
    var pieOffset = 10;
    var radius = Math.min(width, height) / 2 - pieOffset;
    var cx = width/2;
    var cy = height/2;

    var pie = d3.layout.pie()
        .sort(null)
        .value(function(d) {
        	return d.value;
        });
    var arc = d3.svg.arc()
    	.outerRadius(radius * 0.8)
    	.innerRadius(radius * 0.4);
    var outerArc = d3.svg.arc()
    	.innerRadius(radius * 0.9)
    	.outerRadius(radius * 0.9);
    var colorRange = d3.scale.category20();
    var color = d3.scale.ordinal()
    	.range(colorRange.range());

    /* ------- PIE SLICES -------*/
    var legendRectSize = (radius * 0.05);
    var legendSpacing = radius * 0.02;

    var slice = chart.select(".slices").selectAll("path.slice")
        .data(pie(dataset), function(d){ return d.data.label });

    slice.enter()
        .insert("path")
        .attr("transform", "translate(" + cx + " " + cy + ")")
        .style("fill", function(d) { return color(d.data.label); })
        .attr("class", "slice");

    slice.transition().duration(1000)
        .attrTween("d", function(d) {
            this._current = this._current || d;
            var interpolate = d3.interpolate(this._current, d);
            this._current = interpolate(0);
            return function(t) {
                return arc(interpolate(t));
            };
        });

    slice.exit()
        .remove();

    var legend = chart.selectAll('.legend')
        .data(color.domain())
        .enter()
        .append('g')
        .attr('class', 'legend')
        .attr('transform', function(d, i) {
            var height = legendRectSize + legendSpacing;
            var offset =  height * color.domain().length / 2;
            var horz = -3 * legendRectSize + cx;
            var vert = i * height - offset + cy;
            return 'translate(' + horz + ',' + vert + ')';
        });

    legend.append('rect')
        .attr('width', legendRectSize)
        .attr('height', legendRectSize)
        .style('fill', color)
        .style('stroke', color);

    legend.append('text')
        .attr('x', legendRectSize + legendSpacing)
        .attr('y', legendRectSize - legendSpacing)
        .text(function(d) { return d; });

    /* ------- TEXT LABELS -------*/

    var text = chart.select(".labelName").selectAll("text")
        .data(pie(dataset), function(d){ return d.data.label });

    text.enter()
        .append("text")
        .attr("dy", ".35em")
        .text(function(d) {
            return (d.data.label+": "+ (d.value*100).toFixed(1) +"%");
        });

    function midAngle(d){
        return d.startAngle + (d.endAngle - d.startAngle)/2;
    }

    text.transition().duration(1000)
        .attrTween("transform", function(d) {
            this._current = this._current || d;
            var interpolate = d3.interpolate(this._current, d);
            this._current = interpolate(0);
            return function(t) {
                var d2 = interpolate(t);
                var pos = outerArc.centroid(d2);
                pos[0] = radius * (midAngle(d2) < Math.PI ? 1 : -1) + cx;
                pos[1] += cy;
                return "translate("+ pos +")";
            };
        })
        .styleTween("text-anchor", function(d){
            this._current = this._current || d;
            var interpolate = d3.interpolate(this._current, d);
            this._current = interpolate(0);
            return function(t) {
                var d2 = interpolate(t);
                return midAngle(d2) < Math.PI ? "start":"end";
            };
        })
        .text(function(d) {
            return (d.data.label+": "+ (d.value*100).toFixed(1) +"%");
        });


    text.exit()
        .remove();

    /* ------- SLICE TO TEXT POLYLINES -------*/

    var polyline = svg.select(".lines").selectAll("polyline")
        .data(pie(dataset), function(d){ return d.data.label });

    polyline.enter()
        .append("polyline");

    polyline.transition().duration(1000)
        .attrTween("points", function(d){
            this._current = this._current || d;
            var interpolate = d3.interpolate(this._current, d);
            this._current = interpolate(0);
            return function(t) {
                var d2 = interpolate(t);
                var pos = outerArc.centroid(d2);
                var arc_pos = arc.centroid(d2);
                var outerArc_pos = outerArc.centroid(d2);
                arc_pos[0] += cx;
                arc_pos[1] += cy;
                outerArc_pos[0] += cx;
                outerArc_pos[1] += cy;
                pos[0] = radius * 0.95 * (midAngle(d2) < Math.PI ? 1 : -1) + cx;
                pos[1] += cy;
                return [arc_pos, outerArc_pos, pos];
            };
        });

    polyline.exit()
        .remove();
    // var arcs = chart.selectAll(".arc")
    //         .data(pie(dataset)) //pie is the d3.layout.pie function
    //         .enter()
    //         .append("path")
    //         .attr("class", "arc")
    //         .attr("d", arc)
    //         .attr("transform", "translate(" + cx + " " + cy + ")")
    //         .style("fill", function(d,i) { return colorScale(i) });

}

</script>
</html>
