<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="./src/regression.js"></script>
    <link href="style.css" rel="stylesheet" type="text/css">
</head>
<body>
<div id="part1" class="part">
</div>

<div id="part2" class="part">
</div>

<div id="part3" class="part">
</div>
</body>
<script>
var f = "./data/data_clean_full-time.csv"
var degree = 3; // degree of regression

var dataset = [];
var data_wage_work = [];
d3.csv(f, function(data) {
    plotPart1(data);
    plotPart2(data);
});

function plotPart2(data) {
    var svg = d3.select("#part1")
        .append("svg");
}

function plotPart1(data) {
    data_work_wage = data.map(function(d) { return [ +d["work_per_week"], +d["wage"] ]; });
    // median_data = getMedianForY(data_work_wage);
    // console.log(median_data);
    reg_data = getRegressionDataForY(data_work_wage);

    // Set the dimensions of the canvas / graph
    var margin = {top: 30, right: 20, bottom: 30, left: 50},
    width = 1000 - margin.left - margin.right,
    height = 600 - margin.top - margin.bottom;

    // Adds the svg canvas
    var svg = d3.select("#part1")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform",
          "translate(" + margin.left + "," + margin.top + ")");

    plotDataAndSupplyCurve(svg, width, height, data_work_wage, reg_data);
}

function plotDataAndSupplyCurve(svg, width, height, data, line_data) {
    // Set the ranges
    var x = d3.scale.linear().range([0, width]);
    var y = d3.scale.linear().range([height, 0]);

    // Define the axes
    var xAxis = d3.svg.axis().scale(x)
        .orient("bottom").ticks(5);

    var yAxis = d3.svg.axis().scale(y)
        .orient("left").ticks(5);

    // Define the line
    var valueline = d3.svg.line()
        .x(function(d) { return x(d[0]); })
        .y(function(d) { return y(d[1]); })
        .interpolate("basis");

    // Scale the range of the data
    x.domain([0, d3.max(data, function(d) { return d[0]; })]);
    y.domain([0, d3.max(data, function(d) { return d[1]; })]);

    // Add the scatterplot
    svg.selectAll("dot")
        .data(data)
      .enter().append("circle")
        .attr("r", 3.5)
        .attr("cx", function(d) { return x(d[0]); })
        .attr("cy", function(d) { return y(d[1]); });

    // Add the valueline path.
    svg.append("path")
        .attr("class", "line")
        .attr("d", valueline(line_data));

    // Add the X Axis
    svg.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + height + ")")
        .call(xAxis);

    // Add the Y Axis
    svg.append("g")
        .attr("class", "y axis")
        .call(yAxis);

}

function getRegressionDataForY(data) {
    data = data.map(function(d) { return [ +d[1], +d[0] ]; });
    xmax = d3.max(data, function(d) { return d[0]; });
    var myRegression = regression('polynomial', data, degree);
    var equation = myRegression.equation;
    reg_data = [];
    for (var x=0; x<xmax; ++x) {
        var y = 0;
        for(var i=0; i<equation.length; ++i) {
            y += Math.pow(x, i) * equation[i];
        }
        reg_data.push([y, x]);
    }
    // console.log(reg_data);
    return reg_data;
}

function getMedianForY(data) {
    var xs_y = {};
    for (var point of data) {
        x = parseInt(point[0]);
        y = parseInt(point[1]);
        if (xs_y.hasOwnProperty(y)) {
            xs_y[y][0].push(x);
        } else {
            xs_y[y] = [[x], y];
        }
    }
    console.log(Object.keys(xs_y).length);

    var median_data = [];
    for (var key in xs_y) {
        xs = xs_y[key][0];
        y = xs_y[key][1];
        xs.sort(sortInt);
        median = xs[Math.floor(xs.length/2)];
        if (median == undefined) {
            console.log(xs);
        }
        // median_data.push([y, median]);
        median_data.push([median, y]);
    }
    return median_data;
}

function sortInt(a,b) { return a - b; }
</script>
</html>
